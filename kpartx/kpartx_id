#!/bin/bash
#
# kpartx_id
#
# Generates ID information for device-mapper tables.
#
# Copyright (C) 2006 SUSE Linux Products GmbH
# Author:
#       Hannes Reinecke <hare@suse.de>
#
#
#       This program is free software; you can redistribute it and/or modify it
#       under the terms of the GNU General Public License as published by the
#       Free Software Foundation version 2 of the License.
#
# This script generates ID information used to generate persistent symlinks.
# It relies on the UUID strings generated by the various programs; the name
# of the tables are of no consequence.
#
# Please note that dmraid does not provide the UUIDs (yet); a patch has been
# sent upstream but has not been accepted yet.
#

DMSETUP=/sbin/dmsetup

MAJOR=$1
MINOR=$2

if [ -z "$MAJOR" -o -z "$MINOR" ]; then
    echo "usage: $0 major minor"
    exit 1;
fi

# Device-mapper not installed; not an error
if [ ! -x $DMSETUP ] ; then
    exit 0
fi

# Get the table info
tblinfo=$($DMSETUP info -c --noheadings -o name,uuid -j $MAJOR -m $MINOR)
if [ $? -ne 0 ] || [ -z "$tblinfo" ]; then
    exit $?
fi

set -- $(IFS=":"; echo $tblinfo)
tblname=$1
tbluuid=$2

if [ -z "$tbluuid" ] ; then
    exit 0
fi

# Table UUIDs are always '<type>-<uuid>'.
dmuuid=${tbluuid#*-}
dmtbl=${tbluuid%%-*}
dmpart=${dmtbl#part}
# kpartx types are 'part<num>'
if [ "$dmpart" == "$dmtbl" ] ; then
    dmpart=
else
    dmtbl=part
fi

# Set the name of the table. We're only interested in dmraid,
# multipath, and kpartx tables; everything else is ignored.
if [ "$dmtbl" == "part" ] ; then
    # The name of the kpartx table is the name of the parent table
    dmname=$($DMSETUP info  -c --noheadings -o name -u $dmuuid)
    # We need the dependencies of the parent table to figure out
    # the type if the parent is a multipath table
    case "$dmparent" in
	mpath-*)
	    dmdeps=$($DMSETUP deps -u $dmuuid)
	    ;;
    esac
elif [ "$dmtbl" == "mpath" ] ; then
    dmname=$tblname
    # We need the dependencies of the table to figure out the type
    dmdeps=$($DMSETUP deps -u $tbluuid)
elif [ "$dmtbl" == "dmraid" ] ; then
    dmname=$tblname
fi

if [ -z "$dmname" ] ; then
    exit 0
fi

echo "ID_DM_TABLE=$dmtbl"
echo "ID_DM_NAME=$dmname"
[ -n "$dmpart" ] && echo "ID_DM_PART=$dmpart"

# Figure out the type of the map. For non-multipath maps it's
# always 'raid'.
if [ -n "$dmdeps" ] ; then
    case "$dmdeps" in
	*\(94,*)
            echo "ID_DM_TYPE=dasd"
	    ;;
	*\(9*)
            echo "ID_DM_TYPE=raid"
	    ;;
	*)
            echo "ID_DM_TYPE=scsi"
	    ;;
    esac
else
    echo "ID_DM_TYPE=raid"
fi

exit 0
